cmake_minimum_required(VERSION 3.14)
project(blinky LANGUAGES C ASM)

macro(check_defaults var)
    if(NOT DEFINED ${var})
        message(FATAL_ERROR "${var} not set")
    endif()
endmacro()

macro(set_defaults var value)
    if(NOT DEFINED ${var})
        set(${var} ${value})
        message(STATUS "${var} not set, defaults to ${value}")
    endif()
endmacro()

check_defaults(NRF5_SDK_PATH)
set_defaults(NRF5_SDK_COMPONENTS_PATH "${NRF5_SDK_PATH}/components")
set_defaults(NRF5_SDK_COMPONENTS_DRIVERS_NRF_PATH "${NRF5_SDK_PATH}/components/drivers_nrf")

function(nrf5_create_driver_targets target_prefix driver_path targets)
    file(GLOB driver_paths LIST_DIRECTORIES true "${driver_path}/*")
    unset(_tgts)
    foreach(drv_path ${driver_paths})
        get_filename_component(target_name "${drv_path}" NAME)
        set(target_name "${target_prefix}${target_name}")

        file(GLOB drv_sources "${drv_path}/*.c")
        if(NOT drv_sources)
            add_library(${target_name} INTERFACE)
            target_include_directories(${target_name} INTERFACE "${drv_path}")
        else()
            add_library(${target_name} STATIC)
            target_sources(${target_name} PUBLIC ${drv_sources})
            target_include_directories(${target_name} PUBLIC "${drv_path}")
        endif()
        list(APPEND _tgts ${target_name})
    endforeach()
    set(${targets} ${_tgts} PARENT_SCOPE)
endfunction()

nrf5_create_driver_targets(nrf5_drv_ ${NRF5_SDK_COMPONENTS_DRIVERS_NRF_PATH} NRF5_DRIVERS)
foreach(tgt ${NRF5_DRIVERS})
    message(STATUS "Found driver: ${tgt}")
endforeach()

function(nrf5_create_library_targets target_prefix library_path targets)
    file(GLOB driver_paths LIST_DIRECTORIES true "${driver_path}/*")
    unset(_tgts)
    foreach(drv_path ${driver_paths})
        get_filename_component(target_name "${drv_path}" NAME)
        set(target_name "${target_prefix}${target_name}")

    endforeach()

endfunction()

nrf5_create_library_targets(nrf5_lib_ ${NRF5_SDK_COMPONENTS_DRIVERS_NRF_PATH} NRF5_LIBRARIES)
foreach(tgt ${NRF5_LIBRARIES})
    message(STATUS "Found library: ${tgt}")
endforeach()